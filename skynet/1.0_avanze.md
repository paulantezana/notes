-------------------
# Sistema de ventas ZYBER primeros cambios
SQL
    ALTER TABLE mante_almacen ADD COLUMN ColorFondo VARCHAR(16);
    ALTER TABLE mante_almacen ADD COLUMN ColorTexto VARCHAR(16);
--> Procedure == mante_save_almacen

    DELIMITER $$

    USE `zayber`$$

    DROP PROCEDURE IF EXISTS `mante_save_almacen`$$

    CREATE DEFINER=`store_niko`@`localhost` PROCEDURE `mante_save_almacen`(`pId` INT(11), `pAlm` VARCHAR(150), `pSimbolo` VARCHAR(25), `pDescrip` VARCHAR(150), `pRuc` VARCHAR(50), `pRS` VARCHAR(200), `pDireccion` VARCHAR(150), `pColorFondo` VARCHAR(16), `pColorTexto` VARCHAR(16),   `pEstado` INT(1))
    BEGIN
        DECLARE cont INT(11);
        IF(pId>0)THEN
            UPDATE `mante_almacen` SET Almacen=pAlm,Simbolo=pSimbolo,Descripcion=pDescrip,Ruc=pRuc,RazonSocial=pRS,
                Direccion=pDireccion, `ColorFondo`=pColorFondo, `ColorTexto`=pColorTexto, `Estado`=pEstado
            WHERE IdAlmacen=pId;
        ELSE
            SELECT IFNULL(COUNT(*),0) INTO cont FROM `mante_almacen` WHERE Almacen=pAlm;
            IF(cont=0)THEN
                SELECT IFNULL(MAX(IdAlmacen+1),1) INTO pId FROM mante_almacen;
                INSERT INTO mante_almacen VALUES(pId,pAlm,pSimbolo,pEstado,pDescrip,pRuc,pRS,pDireccion,pColorFondo,pColorTexto);
            END IF;
        END IF;
        END$$

    DELIMITER ;

--> ALTER TABLE
    ALTER TABLE `mante_registro_nota_pedido` CHANGE `IdVenta` `IdVenta` INT(11) NOT NULL AUTO_INCREMENT;

Update
    -homeModel.php
    -homeController.php
    -panel_Html.js
    -ManteAlmacen.js
    -Mante.php
    -Procesos.php
    -RegistroVenta.js

-> Mejorar Sistema de ventas
    - Nota de pedido => Agregar nombre cliente.
                     => Manejo de stock
    - Venta rapida importar nota de pedido.
        -> ya no se permite modificar la cantidad **check*
        -> quitar el manejo del stock **ckeck**

        // if ($aIdProducto!='-1') {//en caso de que sea un producto que existe, ya que -1 indica producto no existente
        // 	$query1234="UPDATE `mante_producto_almacen` SET Stock=Stock-'".$aCantidad."'
        // 					WHERE IdAlmacen='".$aIdAlm."' AND IdProducto='".$aIdProducto."';";
        // 	$sql3 = $pdo->prepare($query1234);
        // 	if($sql3->execute()){
        // 		$queryGast="SELECT fn_save_kardex_Venta('".$IdUser."','".$pOrigen."','".$pDestino."','".$aIdAlm."',
        // 					'".$aIdProducto."','".addslashes($aDescripcion)."','".$aCantidad."','".$aPU."',
        // 					'".$aImporte."','".$IdTipoEnt."','".$aComprob."') as con;";
        // 		//echo $queryGast;
        // 		$sql4 = $pdo->prepare($queryGast);				
        // 		if($sql4->execute()){
        // 			$fila4=$sql4->fetchAll();
        // 			$valor=$fila4[0]["con"];
        // 			if($valor==1){$valido=true;}else{$valido=false;}
        // 		}
        // 	}else{$valido=false;}
        // }


    ALTER TABLE mante_registro_nota_pedido ADD COLUMN IdComprobante INT(3);    


proforma

-----------------------------------------------------------------------------------------------
# SISEMA RESTAURANT CAPON
- Numero de mozo => Nombre de mozo
# Cocina
- Otro layout
- Quitar header
- Quitar todo los items
- Reubicar (Logo - Zonas - LoginUser)
    - boton que indique atendido o servido
- Agregar sonido

- Interfaz cocina:
	* Lista de pedidos por atender (preparar)
	* Boton de agrandar orden                                       => Con icono de ZOOM Modal *****
	* Boton de marcar orden como atendida y quitar dicha orden      => Con icono de check verde *****
	* Interfaz actualizada automaticamente                          =>  *****
	* Ordenes listadas por hora de pedido                           => Dibujar por javascript segun la hora de la consulta (consulta por fecha) *****
	* Mosatrar observaciones o notas para cocina                    =>  *****



# SQL AJECUTADO

    ALTER TABLE atencion_clientes ADD COLUMN atendidoCocina TINYINT DEFAULT 0;
    ALTER TABLE detalle_ordens ADD COLUMN atendidoCocina TINYINT DEFAULT 0;

consulta atencion cliente.
    -detalles
    -mesa
    -ordenes

COCINA
    filtrar los nuevos
    atencion
    pintar con prefixId
        - se se encuentra pintar ijos
        - si no pintar todo

Atencion/interfas de atencion
- animacion inicial
- ganar mas espacio
- agregar como marcado por pedido
- orden inverso

233


# Sistema de Ventas Zyber
- la relacon empresa analizar para la facturacion * de momento esta de forma statica*
- Peticion de manuel
    Precio mayor = p.distribuidor
    Precio menor = p.publico

- en compra simple
    Tabla Alm-Pro = Tabla compra simple
    ----------------------------------
    precio mayor == precio distribuido  -- bien
    precio menor == precio base         -- analizar

## Observacion
- En nota de venta exonerado verificar  funcionalidad
- Revisar detalladamente VentaRapida Y nota de pedido

- STORE PROCEDURE MODIFICADO

===
textIdAlmacen_PVNP

$IdAlmacen
===

```sql
    DELIMITER $$

    USE `zayber`$$

    DROP PROCEDURE IF EXISTS `mante_save_almacen`$$

    CREATE DEFINER=`store_niko`@`localhost` PROCEDURE `mante_save_almacen`(`pId` INT(11), `pAlm` VARCHAR(150), `pSimbolo` VARCHAR(25), `pDescrip` VARCHAR(150), `pRuc` VARCHAR(50), `pRS` VARCHAR(200), `pDireccion` VARCHAR(150), `pColorFondo` VARCHAR(16), `pColorTexto` VARCHAR(16),   `pEstado` INT(1))
    BEGIN
    DECLARE cont INT(11);
    IF(pId>0)THEN
        UPDATE `mante_almacen` SET Almacen=pAlm,Simbolo=pSimbolo,Descripcion=pDescrip,Ruc=pRuc,RazonSocial=pRS,
        Direccion=pDireccion, `ColorFondo`=pColorFondo, `ColorTexto`=pColorTexto, `Estado`=pEstado
        WHERE IdAlmacen=pId;
    ELSE
        SELECT IFNULL(COUNT(*),0) INTO cont FROM `mante_almacen` WHERE Almacen=pAlm;
        IF(cont=0)THEN
        SELECT IFNULL(MAX(IdAlmacen+1),1) INTO pId FROM mante_almacen;
        INSERT INTO mante_almacen VALUES(pId,pAlm,pSimbolo,pEstado,pDescrip,pRuc,pRS,pDireccion,pColorFondo,pColorTexto);
        INSERT INTO mante_almacen_empresa VALUES(pId,1);
        END IF;
    END IF;
    END$$

    DELIMITER ;
```

```sql
    DELIMITER $$

    USE `zayber`$$

    DROP FUNCTION IF EXISTS `fn_Save_Productos_importP`$$

    CREATE DEFINER=`store_niko`@`localhost` FUNCTION `fn_Save_Productos_importP`(`pCod` VARCHAR(50), `pDescrip` VARCHAR(200), `pIdMarca` INT(5), `pIdModelo` INT(5), `pCompra` DOUBLE(11,2), `pMayor` DOUBLE(11,2), `pMenor` DOUBLE(11,2), `pPublico` DOUBLE(11,2), `pIdAlm` INT(3)) RETURNS int(2)
        READS SQL DATA
        DETERMINISTIC
    BEGIN
        DECLARE aCont INT(5);
        DECLARE aId INT(11);
        SET aCont=0;SET aId=1;
        
        SELECT IFNULL(COUNT(*),0) INTO aCont FROM `mante_producto` WHERE Codigo=pCod;
        IF(aCont>0)THEN
            SELECT IFNULL(IdProducto,0) INTO aId FROM `mante_producto` WHERE Codigo=pCod LIMIT 1;
            UPDATE `mante_producto` SET Producto=pDescrip,IdMarca=pIdMarca,IdCategoria=pIdModelo
            WHERE IdProducto=aId AND Codigo=pCod;
            SET aCont=0;
            SELECT IFNULL(COUNT(*),0) INTO  aCont FROM `mante_producto_almacen` WHERE IdAlmacen=pIdAlm AND IdProducto=aId;
            IF(aCont>0)THEN
                UPDATE `mante_producto_almacen` SET PrecioCompra=pCompra,PrecioBase=pMenor,PrecioDistribuido=pMayor,
                    PrecioPublico=pPublico
                WHERE IdAlmacen=pIdAlm AND IdProducto=aId;
            ELSE
                INSERT INTO mante_producto_almacen VALUES(pIdAlm,aId,1,1,0,pCompra,pMenor,pMayor,pPublico,1,1);
            END IF;
        ELSE
            SELECT IFNULL(MAX(IdProducto+1),1) INTO aId FROM `mante_producto`;
            INSERT INTO `mante_producto` VALUES(aId,pCod,pDescrip,pIdMarca,pIdModelo,1);
            INSERT INTO mante_producto_almacen VALUES(pIdAlm,aId,1,1,0,pCompra,pMenor,pMayor,pPublico,1,1);
        END IF;
            
        RETURN aId;
    END$$

    DELIMITER ;
```


# Hotel chaski Soporte
- Modifique la funcion para reenviar el comprobante (services/facturacion.php) Reenviar comprobante  linea 475 aproximadamente


# Modificaciones al sistema de minimarqet
- las mismas modificaciones que en el zayber para la importacion de stock desde un archivo excel.


# Modificaciones en el sistema Zayber
- Implementacion de facturacion electronica NUBEFACT.
- Control del stock mostrar detalles.

- Empresas
- Se modificao en almacenes
```sql
DELIMITER $$

USE `db_zayber`$$

DROP PROCEDURE IF EXISTS `mante_save_almacen`$$

CREATE  PROCEDURE `mante_save_almacen`(`pId` INT(11), `pAlm` VARCHAR(150), `pSimbolo` VARCHAR(25), `pDescrip` VARCHAR(150), `pRuc` VARCHAR(50), `pRS` VARCHAR(200), `pDireccion` VARCHAR(150), `pColorFondo` VARCHAR(16), `pColorTexto` VARCHAR(16),   `pEstado` INT(1), `pIdEmpresa` INT(11))
BEGIN
    DECLARE cont INT(11);
    IF(pId>0)THEN
        UPDATE `mante_almacen` SET Almacen=pAlm,Simbolo=pSimbolo,Descripcion=pDescrip,Ruc=pRuc,RazonSocial=pRS,
        Direccion=pDireccion, `ColorFondo`=pColorFondo, `ColorTexto`=pColorTexto, `Estado`=pEstado
        WHERE IdAlmacen=pId;        
	UPDATE `mante_almacen_empresa` SET `IdEmpresa` = pIdEmpresa WHERE IdAlmacen=pId;
    ELSE
        SELECT IFNULL(COUNT(*),0) INTO cont FROM `mante_almacen` WHERE Almacen=pAlm;
        IF(cont=0)THEN
        SELECT IFNULL(MAX(IdAlmacen+1),1) INTO pId FROM mante_almacen;
        INSERT INTO mante_almacen VALUES(pId,pAlm,pSimbolo,pEstado,pDescrip,pRuc,pRS,pDireccion,pColorFondo,pColorTexto);
        INSERT INTO mante_almacen_empresa VALUES(pId,pIdEmpresa);
        END IF;
    END IF;
    END$$

DELIMITER ;
```


Corregir en los detalles
```sql
ALTER TABLE `db_zayber`.`mante_registro_nota_pedido` ADD UNIQUE `idNotaPedidoUnique` (`IdNotaPedido`);

ALTER TABLE `mante_registro_nota_pedido_detalle` DROP INDEX `IdNotaPedidoDetalleUnique`;
ALTER TABLE `db_zayber`.`mante_registro_nota_pedido_detalle` ADD INDEX `IdNotaPedidoDetalleIndex` (`IdNotaPedido`);
```



# Teleredes
- Kiara mirian almeyda hancco
limpiar la base de datos

* 01-15 .

* Zayber examinar detenidamente y mejorar
- Nota de pedido


# Zayber
```sql
UPDATE mante_producto SET `Codigo` = REPLACE(`Codigo`,"'",'&#039;');
UPDATE mante_producto SET `Codigo` = REPLACE(`Codigo`,'"','&quot;');
```



# SS
home model
home controller


colorado  e&l principal
zayber principal.d



* Otras
5.- Tienda principal
vidal pocoricona leon


5. almacen T.P. COMERCIAL L&E
2. empresa 
1. serie


Para consulta el correlativo que le toca
```SQL
SELECT IFNULL(MAX(Numero+1),1) AS aNumero FROM `mante_venta` 
	WHERE IdComprobante=1 AND Serie=1 AND IdEmpresa=2;
```


# IMPORTANTE *
actualizar los detalles de la IdVenta 120 IdAlmacen


	public static function Procesar_MovALm($Datos,$IdUser){
		$IdRegistro = $Datos[0];
		$FechaReg = date("Y-m-d H:i:s", (strtotime ("-5 Hours")));
		$valido = false;
		$mensage = '';

		$pdo = ConexionBD::conectarBD();
		$pdo->beginTransaction();
		try {
			// Consulta origen
			$sql = "SELECT * FROM `mante_movimiento_almacen`  WHERE `IdRegistro` = '$IdRegistro' LIMIT 1";
			$stm = $pdo->prepare($sql);
			if(!$stm->execute()){
				throw new Exception('Error en la consulta movimiento');
			}
			$movimiento = $stm->fetch();
			$idAlmacenOrigen = $movimiento['IdOrigen'];
			$idAlmacenDestino = $movimiento['IdDestino'];

			// Detalle
			$sql = "SELECT modetalle.IdDetalle, modetalle.Cantidad, modetalle.Codigo, modetalle.Producto, modetalle.PUnitario, modetalle.Importe, modetalle.IdProducto,
					pro.`IdCategoria`, pro.`IdMarca`
					FROM `mante_movimiento_almacen_detalle` AS modetalle
					INNER JOIN `mante_producto` AS pro ON modetalle.`IdProducto` = pro.`IdProducto`
					WHERE IdRegistro = '$IdRegistro'";
			$stm = $pdo->prepare($sql);
			if(!$stm->execute()){
				throw new Exception('Error en la consulta detalle movimiento');
			}
			$movimientoDetalles = $stm->fetchAll();


			// Consulta Origen
			$sql = "SELECT * FROM `mante_almacen` WHERE IdAlmacen = '$idAlmacenOrigen' LIMIT 1";
			$stm = $pdo->prepare($sql);
			if(!$stm->execute()){
				throw new Exception('Error en la consulta detalle movimiento');
			}
			$almacenOrigen = $stm->fetch();
			$almacenOrigenDescripcion = $almacenOrigen['Almacen'];

			$sql = "SELECT * FROM `mante_almacen` WHERE IdAlmacen = '$idAlmacenDestino' LIMIT 1";
			$stm = $pdo->prepare($sql);
			if(!$stm->execute()){
				throw new Exception('Error en la consulta detalle movimiento');
			}
			$almacenDestino = $stm->fetch();
			$almacenDestinoDescripcion = $almacenDestino['Almacen'];


			foreach ($movimientoDetalles as $movimientoDetalle) {
				$Cantidad = $movimientoDetalle['Cantidad'];
				$IdProducto = $movimientoDetalle['IdProducto'];
				$PUnitario = $movimientoDetalle['PUnitario'];
				$Importe = $movimientoDetalle['Importe'];
				$Producto = $movimientoDetalle['Producto'];
				// $Unidad = $movimientoDetalle['Unidad'];
				// $IdMarca = $movimientoDetalle['IdMarca'];
				$IdCategoria = $movimientoDetalle['IdCategoria'];
				$Cantidad = (float)$Cantidad;

				// Restando
				$sql = "UPDATE `mante_producto_almacen` SET Stock = (Stock-'$Cantidad') WHERE IdProducto = '$IdProducto' AND IdAlmacen='$idAlmacenOrigen'";
				$stm = $pdo->prepare($sql);
				if(!$stm->execute()){
					throw new Exception('Error al actualizar el stock');
				}

				// Exite ?
				$sql = "SELECT IFNULL(COUNT(*),0) AS acont FROM mante_producto_almacen WHERE IdProducto='$IdProducto' AND IdAlmacen='$idAlmacenDestino'";
				$stm = $pdo->prepare($sql);
				if(!$stm->execute()){
					throw new Exception('Error buscando existencia destino');
				}
				$existe = $stm->fetch();
				if($existe['acont']>0){
					// Summando
					$sql = "UPDATE `mante_producto_almacen` SET Stock = (Stock+'$Cantidad') WHERE IdProducto = '$IdProducto' AND IdAlmacen='$idAlmacenDestino';";
					$stm = $pdo->prepare($sql);
					if(!$stm->execute()){
						throw new Exception('Error en al actualizar almacen destino');
					}
				} else {
					// Insertando
					$sql = "INSERT INTO mante_producto_almacen VALUES('$idAlmacenDestino','$IdProducto',1,1,'$Cantidad','$PUnitario','$PUnitario','$PUnitario','$PUnitario',1,1)";
					$stm = $pdo->prepare($sql);
					if(!$stm->execute()){
						throw new Exception('Error en al actualizar almacen destino');
					}
				}

				// Kardex Origen
				$sql = "SELECT IFNULL(Stock,0) as Stock FROM mante_kardex WHERE IdAlmacen='$idAlmacenOrigen' AND IdProducto='$IdProducto' ORDER BY '$FechaReg' DESC LIMIT 1";
				$stm = $pdo->prepare($sql);
				if(!$stm->execute()){
					throw new Exception('Error buscando existencia destino');
				}
				$stock = $stm->fetch();
				$nuevoStock = $stock['Stock'] - $Cantidad;

				// INSERT INTO `mante_kardex` VALUES(pFechaReg,pIdUser,ppOriAlm,ppDesAlm,aOriAlm,aIdProducto,aProducto,aCantidad,aPUnitario,aImporte,aStock,9,'Movimiento Alm',2,aFamilia);
				$sql = "INSERT INTO `mante_kardex` VALUES('$FechaReg','$IdUser','$almacenOrigenDescripcion','$almacenDestinoDescripcion','$idAlmacenOrigen','$IdProducto','$Producto','$Cantidad','$PUnitario','$Importe','$nuevoStock',9,'Movimiento Alm',2,'$IdCategoria')";
				$stm = $pdo->prepare($sql);
				if(!$stm->execute()){
					throw new Exception('Error en al actualizar almacen destino');
				}

				// Kardex Destino
				$sql = "SELECT IFNULL(Stock,0) as Stock FROM mante_kardex WHERE IdAlmacen='$idAlmacenDestino' AND IdProducto='$IdProducto' ORDER BY '$FechaReg' DESC LIMIT 1";
				$stm = $pdo->prepare($sql);
				if(!$stm->execute()){
					throw new Exception('Error buscando existencia destino');
				}
				$existe = $stm->fetch();
				$nuevoStock = $stock['Stock'] + $Cantidad;

				// INSERT INTO `mante_kardex` VALUES(pFechaReg,pIdUser,ppDesAlm,ppOriAlm,aDesAlm,aIdProducto,aProducto,aCantidad,aPUnitario,aImporte,aStock,9,'Movimiento Alm',1,aFamilia);
				$sql = "INSERT INTO `mante_kardex` VALUES('$FechaReg','$IdUser','$almacenDestinoDescripcion','$almacenOrigenDescripcion','$idAlmacenDestino','$IdProducto','$Producto','$Cantidad','$PUnitario','$Importe','$nuevoStock',9,'Movimiento Alm',1,'$IdCategoria')";
				$stm = $pdo->prepare($sql);
				if(!$stm->execute()){
					throw new Exception('Error en al actualizar almacen destino');
				}
			}

			// Actualizar estado movimiento
			$sql = "UPDATE `mante_movimiento_almacen` SET Estado = '2' WHERE IdRegistro='$IdRegistro'";
			$stm = $pdo->prepare($sql);
			if(!$stm->execute()){
				throw new Exception('Error en al actualizar el estado del mantenimiento');
			}

			$valido = true;
			$mensage = '';
			$pdo->commit();
		}catch(Exception $e){
			$mensage = $e->getMessage() . $e->getTraceAsString();
			$pdo->rollBack();
		}

		return [
			'success' => $valido,
			'mensage' => $mensage,
		];
 	}






     DELIMITER $$

USE `db_zayber`$$

DROP PROCEDURE IF EXISTS `procesar_movAlm`$$

CREATE DEFINER=`root`@`localhost` PROCEDURE `procesar_movAlm`(IN `pIdVenta` BIGINT(20), IN `pIdUser` INT(11), IN `pFechaReg` DATETIME)
BEGIN
	DECLARE aIdDetalle INT(3);
	DECLARE aCantidad DOUBLE(11,2);
	DECLARE aCodigo VARCHAR(100);
	DECLARE aProducto VARCHAR(100);
	DECLARE aPUnitario DOUBLE(11,2);
	DECLARE aImporte DOUBLE(11,2);
	DECLARE aIdProducto INT(11);
	
	DECLARE aOriAlm INT(11);DECLARE aDesAlm INT(11);
	DECLARE ppOriAlm VARCHAR(100);DECLARE ppDesAlm VARCHAR(100);
	
	DECLARE acont INT(3);
	DECLARE aStock DOUBLE(11,2);
	DECLARE aFamilia INT(5);
	
	DECLARE last_row INT DEFAULT 0;

	DECLARE puntero CURSOR FOR SELECT IdDetalle,Cantidad,Codigo,Producto,PUnitario,Importe,IdProducto
		FROM `mante_movimiento_almacen_detalle` WHERE IdRegistro=pIdVenta;
	
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET last_row = 1;
	
	SELECT IFNULL(IdOrigen,0) INTO aOriAlm FROM `mante_movimiento_almacen` WHERE IdRegistro=pIdVenta LIMIT 1;
	SELECT IFNULL(IdDestino,0) INTO aDesAlm FROM `mante_movimiento_almacen` WHERE IdRegistro=pIdVenta LIMIT 1;
	SET ppOriAlm='';
    SET ppDesAlm='';
    SET aFamilia=-1;
	SELECT IFNULL(Almacen,'') INTO ppOriAlm FROM `mante_almacen` WHERE IdAlmacen=aOriAlm LIMIT 1;
	SELECT IFNULL(Almacen,'') INTO ppDesAlm FROM `mante_almacen` WHERE IdAlmacen=aDesAlm LIMIT 1;
	
	SET aStock=0;SET acont=0;
	OPEN puntero;
		start_loop: LOOP
			FETCH puntero INTO aIdDetalle,aCantidad,aCodigo,aProducto,aPUnitario,aImporte,aIdProducto;
			IF(last_row=1) THEN
				LEAVE start_loop;
			END IF;
			UPDATE `mante_producto_almacen` SET Stock=Stock-aCantidad WHERE IdProducto=aIdProducto AND IdAlmacen=aOriAlm;
			
			SELECT IFNULL(COUNT(*),0) INTO acont FROM mante_producto_almacen WHERE IdProducto=aIdProducto AND IdAlmacen=aDesAlm;
			IF(acont>0)THEN
				UPDATE `mante_producto_almacen` SET Stock=Stock+aCantidad WHERE IdProducto=aIdProducto AND IdAlmacen=aDesAlm;
			ELSE
				INSERT INTO mante_producto_almacen VALUES(aDesAlm,aIdProducto,1,1,aCantidad,aPUnitario,aPUnitario,aPUnitario,aPUnitario,1,1);
			END IF;
			SELECT IFNULL(IdCategoria,-1) INTO aFamilia FROM `mante_producto` WHERE IdProducto=aIdProducto LIMIT 1;
			


            
			SELECT IFNULL(Stock,0) INTO aStock FROM mante_kardex WHERE IdAlmacen=aOriAlm AND IdProducto=aIdProducto ORDER BY FechaReg DESC LIMIT 1;
			SET aStock=aStock-aCantidad;

			INSERT INTO `mante_kardex` VALUES(pFechaReg,pIdUser,ppOriAlm,ppDesAlm,aOriAlm,aIdProducto,aProducto,aCantidad,aPUnitario,aImporte,aStock,9,'Movimiento Alm',2,aFamilia);
			
			SELECT IFNULL(Stock,0) INTO aStock FROM mante_kardex WHERE IdAlmacen=aDesAlm AND IdProducto=aIdProducto ORDER BY FechaReg DESC LIMIT 1;
			SET aStock=0;
			SET aStock=aStock+aCantidad;
			
			INSERT INTO `mante_kardex` VALUES(pFechaReg,pIdUser,ppDesAlm,ppOriAlm,aDesAlm,aIdProducto,aProducto,aCantidad,aPUnitario,aImporte,aStock,9,'Movimiento Alm',1,aFamilia);
			
		END LOOP start_loop;
	CLOSE puntero;
	UPDATE `mante_movimiento_almacen` SET Estado=2 WHERE IdRegistro=pIdVenta; 
    END$$

DELIMITER ;